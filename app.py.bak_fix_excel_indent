import streamlit as st
import io
import pandas as pd
from datetime import date, timedelta

from src.db import init_db
from src.staff_repo import (
    add_staff, add_staff_bulk, list_staff, set_staff_active, delete_staff
)
from src.unavailability_repo import (
    add_unavailability_range, list_unavailability, delete_unavailability
)
from src.requests_repo import (
    add_request, list_requests, set_request_status, delete_request, list_approved_requests
)
from src.holidays_repo import (
    add_holidays, list_holidays, delete_holiday
)
from src.calendar_utils import (
    iter_month_days, count_weekdays_excluding_holidays
)
from src.blockers import build_blocked_days_with_type
from src.scheduler import build_required_shifts, SHIFT_HOURS, generate_schedule_hard_min_hours
from src.assignments_repo import clear_month, insert_assignments, list_month
from src.rules_repo import ensure_rules_table, add_rule, list_rules, set_rule_active, delete_rule

st.set_page_config(page_title="NÃ¶bet PlanlayÄ±cÄ±", layout="wide")
init_db()
ensure_rules_table()

st.title("AkÄ±llÄ± NÃ¶bet / Vardiya PlanlayÄ±cÄ±")

tab_staff, tab_unav, tab_req, tab_cal, tab_rules, tab_plan = st.tabs(
    ["ğŸ‘©â€âš•ï¸ Personel", "ğŸ©º Rapor / Ä°zin", "ğŸ“ Ä°stek Defteri", "ğŸ“… Takvim & Tatiller", "âš™ï¸ Kurallar", "ğŸ“‹ Plan"]
)

# -------------------- PERSONEL --------------------
with tab_staff:
    st.subheader("Personel YÃ¶netimi")

    col1, col2 = st.columns(2)

    with col1:
        st.markdown("### Tek Tek Ekle")
        name = st.text_input("HemÅŸire adÄ± soyadÄ±", placeholder="Ã–rn: AyÅŸe YÄ±lmaz", key="staff_name")
        if st.button("Ekle", type="primary", key="staff_add_one"):
            add_staff(name)
            st.success("Eklendi âœ…")
            st.rerun()

        st.markdown("---")
        st.markdown("### Toplu Ekle (40 kiÅŸi iÃ§in)")
        bulk = st.text_area(
            "Her satÄ±ra 1 isim yaz",
            height=200,
            placeholder="AyÅŸe YÄ±lmaz\nElif Demir\n...",
            key="staff_bulk"
        )
        if st.button("Toplu Ekle", key="staff_add_bulk"):
            names = [n.strip() for n in bulk.splitlines() if n.strip()]
            count = add_staff_bulk(names)
            st.success(f"{count} kiÅŸi eklendi âœ…")
            st.rerun()

    with col2:
        st.markdown("### Liste")
        filter_opt = st.radio("Filtre", ["Hepsi", "Aktif", "Pasif"], horizontal=True, key="staff_filter")
        only_active = None
        if filter_opt == "Aktif":
            only_active = True
        elif filter_opt == "Pasif":
            only_active = False

        rows = list_staff(only_active=only_active)

        if not rows:
            st.info("HenÃ¼z personel yok.")
        else:
            for r in rows:
                staff_id = int(r["id"])
                full_name = r["full_name"]
                is_active = bool(r["is_active"])

                c1, c2, c3 = st.columns([6, 2, 2])
                with c1:
                    st.write(f"**{full_name}**  (ID: {staff_id})")
                with c2:
                    if is_active:
                        if st.button("Pasif Yap", key=f"deact_{staff_id}"):
                            set_staff_active(staff_id, False)
                            st.rerun()
                    else:
                        if st.button("Aktif Yap", key=f"act_{staff_id}"):
                            set_staff_active(staff_id, True)
                            st.rerun()
                with c3:
                    if st.button("Sil", key=f"del_{staff_id}"):
                        delete_staff(staff_id)
                        st.rerun()

# -------------------- RAPOR / Ä°ZÄ°N --------------------
with tab_unav:
    st.subheader("Rapor / YÄ±llÄ±k Ä°zin (Ã‡alÄ±ÅŸÄ±lamayan GÃ¼nler)")

    staff_rows = list_staff(only_active=True)
    if not staff_rows:
        st.warning("Ã–nce aktif personel eklemelisin.")
    else:
        staff_map = {f'{r["full_name"]} (ID:{r["id"]})': int(r["id"]) for r in staff_rows}
        selected_label = st.selectbox("Personel seÃ§", list(staff_map.keys()), key="u_staff")
        staff_id = staff_map[selected_label]

        c1, c2 = st.columns(2)
        with c1:
            utype = st.selectbox("TÃ¼r", ["rapor", "yillik_izin"], key="u_type")
            note = st.text_input("Not (opsiyonel)", placeholder="Ã–rn: okul / saÄŸlÄ±k / Ã¶zel durum", key="u_note")
        with c2:
            start = st.date_input("BaÅŸlangÄ±Ã§", value=date.today(), key="u_start")
            end = st.date_input("BitiÅŸ", value=date.today(), key="u_end")

        if end < start:
            st.error("BitiÅŸ tarihi baÅŸlangÄ±Ã§tan Ã¶nce olamaz.")
        else:
            days = []
            cur = start
            while cur <= end:
                days.append(cur.isoformat())
                cur += timedelta(days=1)

            if st.button("Kaydet", type="primary", key="u_save"):
                add_unavailability_range(staff_id, days, utype, note)
                st.success(f"{len(days)} gÃ¼n kaydedildi âœ…")
                st.rerun()

        st.markdown("---")
        st.markdown("### KayÄ±tlar")
        filt = st.checkbox("Sadece seÃ§ili personeli gÃ¶ster", value=True, key="u_filt")
        rows = list_unavailability(staff_id if filt else None)

        if not rows:
            st.info("KayÄ±t yok.")
        else:
            for r in rows:
                rid = int(r["id"])
                extra = ((" | " + r["note"]) if r["note"] else "")
                st.write(f'**{r["date"]}** â€” {r["full_name"]} â€” `{r["type"]}`{extra}')
                if st.button("Sil", key=f"unav_del_{rid}"):
                    delete_unavailability(rid)
                    st.rerun()

# -------------------- Ä°STEK DEFTERÄ° --------------------
with tab_req:
    st.subheader("Ä°stek Defteri (Okul / EÄŸitim / Ã‡ocuk / Ã–zel Durum)")

    staff_rows = list_staff(only_active=True)
    if not staff_rows:
        st.warning("Ã–nce aktif personel eklemelisin.")
    else:
        staff_map = {f'{r["full_name"]} (ID:{r["id"]})': int(r["id"]) for r in staff_rows}
        selected_label = st.selectbox("Personel seÃ§ (ÅŸimdilik login yerine)", list(staff_map.keys()), key="req_staff")
        staff_id = staff_map[selected_label]

        req_kind = st.selectbox("Ä°stek tipi", ["HARD", "SOFT"], index=0, key="req_kind")
        req_day = st.date_input("Ä°stek gÃ¼nÃ¼", value=date.today() + timedelta(days=14), key="req_day")
        req_note = st.text_area(
            "Ä°stek notu",
            height=120,
            placeholder="Ã–rn: Okul var, o gÃ¼n boÅŸ olsun / EÄŸitim var / Ã‡ocuk hastane randevusuâ€¦",
            key="req_note"
        )

        days_ahead = (req_day - date.today()).days
        if days_ahead < 14:
            st.warning(
                f"Bu istek {days_ahead} gÃ¼n sonra. Kural: en az 14 gÃ¼n Ã¶nceden bildirim. "
                "Yine de kaydedilebilir, yÃ¶netici karar verir."
            )

        if st.button("Ä°stek Kaydet", type="primary", key="req_save"):
            add_request(staff_id, req_day.isoformat(), req_note, req_kind)
            st.success("Ä°stek kaydedildi âœ…")
            st.rerun()

        st.markdown("---")
        st.markdown("### YÃ¶netici GÃ¶rÃ¼nÃ¼mÃ¼ (Ä°stek Listesi)")

        status_label_map = {"Beklemede": "pending", "OnaylandÄ±": "approved", "Reddedildi": "rejected"}
        status_tr_map = {"pending": "Beklemede", "approved": "OnaylandÄ±", "rejected": "Reddedildi"}

        filter_status = st.radio(
            "Durum filtresi",
            ["Hepsi", "Beklemede", "OnaylandÄ±", "Reddedildi"],
            horizontal=True,
            key="req_filter_status"
        )
        status = None if filter_status == "Hepsi" else status_label_map[filter_status]
        reqs = list_requests(status=status)

        if not reqs:
            st.info("Ä°stek yok.")
        else:
            for r in reqs:
                rid = int(r["id"])
                kind = (r.get("request_kind") or "HARD").upper()
                st.write(
                    f'**{r["date"]}** â€” {r["full_name"]} â€” '
                    f'**{status_tr_map.get(r["status"], r["status"])}**  |  Tip: `{kind}`'
                )
                st.caption(f'{r["note"]}  |  OluÅŸturma: {r["created_at"]}')

                c1, c2, c3 = st.columns([1, 1, 1])
                with c1:
                    if st.button("Onayla", key=f"req_ok_{rid}"):
                        set_request_status(rid, "approved")
                        st.rerun()
                with c2:
                    if st.button("Reddet", key=f"req_no_{rid}"):
                        set_request_status(rid, "rejected")
                        st.rerun()
                with c3:
                    if st.button("Sil", key=f"req_del_{rid}"):
                        delete_request(rid)
                        st.rerun()

        st.info("Not: OnaylÄ± HARD istekler planlamada 'kesin boÅŸ' (hard). OnaylÄ± SOFT istekler ise mÃ¼mkÃ¼nse boÅŸ bÄ±rakÄ±lÄ±r.")

# -------------------- TAKVÄ°M & TATÄ°LLER --------------------
with tab_cal:
    st.subheader("Takvim & ResmÃ® Tatiller")

    today = date.today()
    c1, c2 = st.columns(2)
    with c1:
        year = st.number_input("YÄ±l", min_value=2020, max_value=2100, value=today.year, step=1, key="cal_year")
    with c2:
        month = st.selectbox("Ay", list(range(1, 13)), index=today.month - 1, key="cal_month")

    days = iter_month_days(int(year), int(month))
    st.caption(f"SeÃ§ilen ay gÃ¼n sayÄ±sÄ±: **{len(days)}**")

    holiday_list = list_holidays()
    holiday_set = set(holiday_list)

    st.markdown("### Ay gÃ¼nleri (Tatil seÃ§)")
    options = [d.iso for d in days]
    default_selected = [d for d in options if d in holiday_set]
    selected_holidays = st.multiselect("ResmÃ® tatiller", options=options, default=default_selected, key="cal_hols")

    if st.button("Tatil Kaydet", type="primary", key="cal_save"):
        for d in default_selected:
            delete_holiday(d)
        add_holidays(selected_holidays)
        st.success("Tatiller gÃ¼ncellendi âœ…")
        st.rerun()

    st.markdown("---")
    weekday_count = count_weekdays_excluding_holidays(int(year), int(month), set(selected_holidays))
    min_month_hours = weekday_count * 8

    st.markdown("### Minimum aylÄ±k mesai hesabÄ±")
    st.write(f"**Hafta iÃ§i gÃ¼n sayÄ±sÄ± (tatiller hariÃ§):** {weekday_count}")
    st.write(f"**Minimum aylÄ±k mesai (hard):** {weekday_count} Ã— 8 = **{min_month_hours} saat**")

# -------------------- KURALLAR (EKLE/SÄ°L) --------------------
with tab_rules:
    st.subheader("Kural YÃ¶netimi (PrevShift â†’ NextShift yasak)")

    st.info("Buraya sadece 'YASAK' kurallarÄ± ekliyoruz. Serbest olanlarÄ± eklemen gerekmez.")

    c1, c2, c3 = st.columns([2, 2, 4])
    with c1:
        prev_type = st.selectbox(
            "DÃ¼n (Prev)",
            ["DAY", "NIGHT", "D24", "RAPOR", "YILLIK_IZIN", "ANY"],
            index=1,
            key="rule_prev"
        )
    with c2:
        next_type = st.selectbox("BugÃ¼n (Next)", ["DAY", "NIGHT", "D24", "ANY"], index=3, key="rule_next")
    with c3:
        apply_day = st.selectbox("Hangi gÃ¼nlerde geÃ§erli?", ["ANY", "WEEKDAY", "WEEKEND"], index=0, key="rule_apply_day")
        note = st.text_input("Not (opsiyonel)", placeholder="Ã–rn: 24 sonrasÄ± ertesi gÃ¼n Ã§alÄ±ÅŸma yok", key="rule_note")

    if st.button("Kural Ekle", type="primary", key="rule_add"):
        add_rule(prev_type, next_type, apply_day, note)
        st.success("Kural eklendi âœ…")
        st.rerun()

    st.markdown("---")
    st.markdown("### Kural Listesi")

    filt = st.radio("Filtre", ["Hepsi", "Aktif", "Pasif"], horizontal=True, key="rules_filter_rules_tab")
    if filt == "Aktif":
        rows = list_rules(active_only=True)
    elif filt == "Pasif":
        rows = list_rules(active_only=False)
    else:
        rows = list_rules(active_only=None)

    if not rows:
        st.info("HenÃ¼z kural yok.")
    else:
        for r in rows:
            rid = int(r["id"])
            is_active = bool(r["is_active"])
            label = "âœ… Aktif" if is_active else "â›” Pasif"
            ad = r.get("apply_day", "ANY")
            st.write(
                f'**#{rid}**  {label}  â€”  `{r["prev_type"]} -> {r["next_type"]}`  '
                f'(GÃ¼n: **{ad}**)  {(" | " + r["note"]) if r["note"] else ""}'
            )

            b1, b2, b3 = st.columns([1, 1, 1])
            with b1:
                if is_active:
                    if st.button("Pasif Yap", key=f"rule_off_{rid}"):
                        set_rule_active(rid, False)
                        st.rerun()
                else:
                    if st.button("Aktif Yap", key=f"rule_on_{rid}"):
                        set_rule_active(rid, True)
                        st.rerun()
            with b2:
                if st.button("Sil", key=f"rule_del_{rid}"):
                    delete_rule(rid)
                    st.rerun()
            with b3:
                st.caption(r.get("created_at", ""))

# -------------------- PLAN --------------------
with tab_plan:
    st.subheader("Plan (Basit v0 + HARD min mesai + Kurallar + Ä°stekler)")

    today = date.today()
    c1, c2 = st.columns(2)
    with c1:
        year = st.number_input("YÄ±l", min_value=2020, max_value=2100, value=today.year, step=1, key="p_year")
    with c2:
        month = st.selectbox("Ay", list(range(1, 13)), index=today.month - 1, key="p_month")

    staff_rows = list_staff(only_active=True)
    if not staff_rows:
        st.warning("Ã–nce aktif personel eklemelisin.")
    else:
        staff_ids = [int(r["id"]) for r in staff_rows]
        staff_name_by_id = {int(r["id"]): r["full_name"] for r in staff_rows}

        required = build_required_shifts(int(year), int(month))
        st.caption(f"Bu ay toplam slot: **{len(required)}** (hafta iÃ§i 24 kiÅŸi/gÃ¼n, hafta sonu 12 kiÅŸi/gÃ¼n)")

        holiday_set = set(list_holidays())
        weekday_count = count_weekdays_excluding_holidays(int(year), int(month), holiday_set)
        min_required_hours = weekday_count * 8
        st.info(f"Hard kural: Her Ã§alÄ±ÅŸan en az **{min_required_hours} saat** Ã§alÄ±ÅŸmalÄ±.")

        # ---- OnaylÄ± istekler (HARD/SOFT) ----
        st.markdown("---")
        st.markdown("### âœ… OnaylÄ± Ä°stekler (HARD / SOFT)")
        approved = list_approved_requests(int(year), int(month))
        if not approved:
            st.info("Bu ay iÃ§in onaylÄ± istek yok.")
        else:
            for r in approved:
                kind = (r.get("request_kind") or "HARD").upper()
                st.write(f'**{r["date"]}** â€” {r["full_name"]} â€” Tip: `{kind}`')
                if r.get("note"):
                    st.caption(r["note"])

        # ---- SOFT isteÄŸe raÄŸmen atananlar (ÅŸeffaflÄ±k) ----
        st.markdown("### âš ï¸ SOFT isteÄŸe raÄŸmen atananlar")
        # Mevcut plan varsa kontrol edelim
        plan_rows_now = list_month(int(year), int(month))
        if not plan_rows_now:
            st.info("Ã–nce plan Ã¼retince burada SOFT Ã§atÄ±ÅŸmalarÄ±nÄ± gÃ¶stereceÄŸim.")
        else:
            assigned_set = {(r["date"], int(r["staff_id"])) for r in plan_rows_now}
            soft_conflicts = []
            for r in approved:
                kind = (r.get("request_kind") or "HARD").upper()
                if kind == "SOFT":
                    if (r["date"], int(r["staff_id"])) in assigned_set:
                        soft_conflicts.append(r)

            if not soft_conflicts:
                st.success("SOFT isteklerle Ã§akÄ±ÅŸan atama yok âœ… (mÃ¼mkÃ¼n olduÄŸunca boÅŸ bÄ±rakÄ±ldÄ±)")
            else:
                st.warning(f"SOFT isteÄŸe raÄŸmen atanan kiÅŸi sayÄ±sÄ±: {len(soft_conflicts)}")
                for r in soft_conflicts:
                    st.write(f'**{r["date"]}** â€” {r["full_name"]} â€” Tip: `SOFT` (ama atanmÄ±ÅŸ)')
                    if r.get("note"):
                        st.caption(r["note"])


        transition_rules = list_rules(active_only=True)
        st.write(f"Aktif geÃ§iÅŸ kuralÄ± sayÄ±sÄ±: **{len(transition_rules)}**")

        if st.button("Plan Ãœret (Hard min)", type="primary", key="plan_btn"):
            # blockers: rapor/izin + approved HARD istek + approved SOFT istek (soft_avoid)
            blocked_any, blocked_type, soft_avoid = build_blocked_days_with_type(int(year), int(month))

            assignments, unfilled, hours, swaps = generate_schedule_hard_min_hours(
                int(year), int(month), staff_ids, blocked_any, min_required_hours,
                transition_rules=transition_rules,
                blocked_type=blocked_type,
                soft_avoid=soft_avoid
            )

            clear_month(int(year), int(month))
            # FIX: normalize assignments (tuple -> dict) before DB insert
            if assignments and isinstance(assignments[0], (tuple, list)):
                assignments = [{"date": a[0], "shift_type": a[1], "staff_id": a[2]} for a in assignments]
            insert_assignments(assignments)

            if unfilled:
                st.warning(f"Doldurulamayan slot: {len(unfilled)} (kural Ã§akÄ±ÅŸmasÄ± / personel yetersizliÄŸi olabilir)")

            deficits = [sid for sid in staff_ids if hours.get(sid, 0) < min_required_hours]
            if deficits:
                st.error(
                    f"Hard min hedefi tam saÄŸlanamadÄ±. Eksi kalan kiÅŸi sayÄ±sÄ±: {len(deficits)}. "
                    "Bu, mevcut kurallar ile %100 mÃ¼mkÃ¼n olmayabilir."
                )
            else:
                st.success(f"Plan kaydedildi âœ… (Dengeleme swap sayÄ±sÄ±: {swaps})")

            st.rerun()

        st.markdown("---")
        st.markdown("### Plan Ã§Ä±ktÄ±sÄ± (gÃ¼n gÃ¼n)")

        rows = list_month(int(year), int(month))
        if not rows:
            st.info("Bu ay iÃ§in plan yok. 'Plan Ãœret' butonuna bas.")
        else:

            # === MATRIX_VIEW_START ===
            st.markdown("---")
            st.markdown("### ğŸ“Š AylÄ±k Ã‡izelge (Sadece YazÄ± Rengi)")

            # blocked_type (rapor / yÄ±llÄ±k izin) unavailability tablosundan Ã¼ret (ROBUST)
            blocked_type = {}
            unav_count = 0
            yyyymm = f"{int(year)}-{int(month):02d}-"

            # name->id dÃ¶nÃ¼ÅŸÃ¼mÃ¼ (lokal)
            name_to_id_local = {v: k for k, v in staff_name_by_id.items()}

            def _as_dict(x):
                # sqlite Row gibi ise dict() Ã§alÄ±ÅŸÄ±r; deÄŸilse zaten dict olabilir
                try:
                    return dict(x)
                except Exception:
                    return x if isinstance(x, dict) else {}

            try:
                unav_rows = list_unavailability(None)

                for ur0 in unav_rows:
                    ur = _as_dict(ur0)

                    # date bazen "date" bazen "day" olabilir
                    d = ur.get("date") or ur.get("day")
                    if not d:
                        continue
                    d = str(d)
                    # bazÄ± DB'lerde "2026-02-01 00:00:00" gibi gelebilir
                    d = d.split(" ")[0].split("T")[0]

                    if not d.startswith(yyyymm):
                        continue

                    sid = ur.get("staff_id")
                    if sid is None:
                        sid = name_to_id_local.get(ur.get("full_name"))
                    if sid is None:
                        continue
                    sid = int(sid)

                    t = ur.get("type") or ur.get("utype")
                    if t not in ("rapor", "yillik_izin"):
                        continue

                    blocked_type.setdefault(sid, {})[d] = t
                    unav_count += 1

            except Exception as e:
                blocked_type = {}
                unav_count = 0
                st.warning(f"Rapor/izin okunamadÄ±: {e}")

            st.caption(f"Bu ay rapor/izin kaydÄ±: {unav_count}")
            
            name_to_id = {v: k for k, v in staff_name_by_id.items()}

            # Ay gÃ¼nleri: 01..(ayÄ±n son gÃ¼nÃ¼)
            day_infos = iter_month_days(int(year), int(month))
            day_isos = [d.iso for d in day_infos]
            day_cols = [str(int(d.iso.split("-")[2])).zfill(2) for d in day_infos]  # 01..31
            col_to_iso = {c: iso for c, iso in zip(day_cols, day_isos)}

            # Personel listesi
            staff_df = pd.DataFrame(
                [{"Personel": staff_name_by_id.get(sid, f"ID:{sid}"), "ID": sid} for sid in staff_ids]
            ).sort_values(["Personel", "ID"]).reset_index(drop=True)

            # HÃ¼cre: (staff_id, date)->shift_type
            cell = {}
            for r in rows:
                sid = r.get("staff_id")
                if sid is None:
                    sid = name_to_id.get(r.get("full_name"))
                if sid is None:
                    continue
                sid = int(sid)

                d_iso = r.get("date")
                stype = r.get("shift_type")
                if not d_iso or not stype:
                    continue

                key = (sid, d_iso)
                if key in cell and stype not in cell[key].split("+"):
                    cell[key] = cell[key] + "+" + stype
                else:
                    cell.setdefault(key, stype)

            # Matris tablo (DAY=8, NIGHT=16, D24=24, RAPOR=R, Ä°ZÄ°N=Ä°)
            matrix_rows = []
            for _, rr in staff_df.iterrows():
                sid = int(rr["ID"])
                row = {"Personel": rr["Personel"], "ID": sid}

                for d_iso, dcol in zip(day_isos, day_cols):
                    bt = blocked_type.get(sid, {}).get(d_iso)
                    if bt == "rapor":
                        row[dcol] = "R"
                        continue
                    if bt == "yillik_izin":
                        row[dcol] = "Ä°"
                        continue

                    stype = cell.get((sid, d_iso), "")
                    if stype.startswith("DAY"):
                        row[dcol] = "8"
                    elif stype.startswith("NIGHT"):
                        row[dcol] = "16"
                    elif stype.startswith("D24"):
                        row[dcol] = "24"
                    else:
                        row[dcol] = ""
                matrix_rows.append(row)

            df_matrix = pd.DataFrame(matrix_rows)

            # AÃ§Ä±klama: rapor/izin gÃ¼n sayÄ±sÄ± (EN SON sÃ¼tun)
            aciklama = []
            for sid in df_matrix["ID"].tolist():
                sid = int(sid)
                mp = blocked_type.get(sid, {})
                rapor = sum(1 for _, t in mp.items() if t == "rapor")
                izin  = sum(1 for _, t in mp.items() if t == "yillik_izin")
                parts = []
                if rapor:
                    parts.append(f"{rapor} gÃ¼n raporlu")
                if izin:
                    parts.append(f"{izin} gÃ¼n izinli")
                aciklama.append(" | ".join(parts) if parts else "")
            df_matrix["AÃ§Ä±klama"] = aciklama

            # ===== MESAI OZETI SUTUNLARI =====
            # Min saat: (tatiller hariÃ§) hafta iÃ§i gÃ¼n sayÄ±sÄ± Ã— 8
            min_required_hours = weekday_count * 8

            # Ã‡alÄ±ÅŸÄ±lan saat: DB'deki rows (shift_type) Ã¼zerinden hesapla
            HOURS_MAP = {"DAY": 8, "NIGHT": 16, "D24": 24}

            worked = {sid: 0 for sid in staff_ids}
            for rr in rows:
                sid = rr.get("staff_id")
                if sid is None:
                    sid = name_to_id.get(rr.get("full_name"))
                if sid is None:
                    continue
                sid = int(sid)

                stype = (rr.get("shift_type") or "")
                # bazen "DAY+NIGHT" gibi birleÅŸik olabilir
                parts = str(stype).split("+")
                for part in parts:
                    part = part.strip()
                    if part.startswith("DAY"):
                        worked[sid] += HOURS_MAP["DAY"]
                    elif part.startswith("NIGHT"):
                        worked[sid] += HOURS_MAP["NIGHT"]
                    elif part.startswith("D24"):
                        worked[sid] += HOURS_MAP["D24"]

            df_matrix["MinSaat"] = min_required_hours
            df_matrix["CalistigiSaat"] = df_matrix["ID"].map(lambda x: worked.get(int(x), 0))
            df_matrix["Fark"] = df_matrix["CalistigiSaat"] - df_matrix["MinSaat"]
            # ===== /MESAI OZETI =====


            # Kolon sÄ±rasÄ±: AÃ§Ä±klama en sonda
            ordered_cols = ["Personel", "ID"] + day_cols + ["MinSaat", "CalistigiSaat", "Fark", "AÃ§Ä±klama"]
            df_matrix = df_matrix[ordered_cols]

            # Sadece YAZI rengi (arka plan deÄŸiÅŸtirme YOK)
            COLOR_DAY   = "#2F75B5"  # mavi
            COLOR_NIGHT = "#C9A100"  # sarÄ± (daha okunur)
            COLOR_D24   = "#2E8B57"  # yeÅŸil
            COLOR_BLOCK = "#C00000"  # kÄ±rmÄ±zÄ±

            def style_text_only(data: pd.DataFrame):
                styles = pd.DataFrame("", index=data.index, columns=data.columns)
                for c in day_cols:
                    for i in data.index:
                        v = str(data.loc[i, c] or "")
                        if v == "8":
                            styles.loc[i, c] = f"color: {COLOR_DAY};"
                        elif v == "16":
                            styles.loc[i, c] = f"color: {COLOR_NIGHT};"
                        elif v == "24":
                            styles.loc[i, c] = f"color: {COLOR_D24};"
                        elif v in ("R", "Ä°"):
                            styles.loc[i, c] = f"color: {COLOR_BLOCK};"
                return styles

            styler = df_matrix.style.apply(style_text_only, axis=None)
            st.dataframe(styler, width='stretch', height=680)

            st.markdown("### â¬‡ï¸ Ã‡izelgeyi Ä°ndir (CSV / Excel)")
            st.download_button(
                "ğŸ“„ CSV indir (Ã‡izelge)",
                data=df_matrix.to_csv(index=False).encode("utf-8"),
                file_name=f"cizelge_{int(year)}_{int(month):02d}.csv",
                mime="text/csv",
                key="dl_matrix_csv"
            )

            xlsx_buf = io.BytesIO()
            try:
    from openpyxl.styles import Font
    from openpyxl.utils import get_column_letter

    with pd.ExcelWriter(xlsx_buf, engine="openpyxl") as writer:
        df_matrix.to_excel(writer, index=False, sheet_name="Cizelge")

        ws = writer.sheets["Cizelge"]

        # Excel hÃ¼crelerinde sadece YAZI rengi (arka plan yok)
        FONT_DAY   = Font(color="2F75B5")  # mavi
        FONT_NIGHT = Font(color="C9A100")  # sarÄ±
        FONT_D24   = Font(color="2E8B57")  # yeÅŸil
        FONT_BLOCK = Font(color="C00000")  # kÄ±rmÄ±zÄ±

        # header satÄ±rÄ± 1, data satÄ±rlarÄ± 2..n
        # sÃ¼tun indexlerini bul (Personel, ID, gÃ¼nler, AÃ§Ä±klama...)
        headers = [cell.value for cell in ws[1]]
        # gÃ¼n sÃ¼tunlarÄ±: "01","02",...
        day_cols = [h for h in headers if isinstance(h, str) and len(h) == 2 and h.isdigit()]
        day_col_indexes = [headers.index(h) + 1 for h in day_cols]  # 1-based

        # GÃ¼n hÃ¼crelerini renklendir
        for row in range(2, ws.max_row + 1):
            for col in day_col_indexes:
                v = ws.cell(row=row, column=col).value
                if v is None:
                    continue
                v = str(v).strip()
                if v == "8":
                    ws.cell(row=row, column=col).font = FONT_DAY
                elif v == "16":
                    ws.cell(row=row, column=col).font = FONT_NIGHT
                elif v == "24":
                    ws.cell(row=row, column=col).font = FONT_D24
                elif v in ("R", "Ä°"):
                    ws.cell(row=row, column=col).font = FONT_BLOCK

        # (opsiyonel) sÃ¼tun geniÅŸliÄŸi biraz artsÄ±n
        for col_idx in range(1, ws.max_column + 1):
            col_letter = get_column_letter(col_idx)
            ws.column_dimensions[col_letter].width = 10

    xlsx_buf.seek(0)
    st.download_button(
        "ğŸ“Š Excel indir (.xlsx)",
        data=xlsx_buf,
        file_name=f"cizelge_{int(year)}_{int(month):02d}.xlsx",
        mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
        key="dl_matrix_xlsx"
    )
            except Exception as e:
            st.warning(f"Excel export Ã§alÄ±ÅŸmadÄ±: {e} (CSV her zaman Ã§alÄ±ÅŸÄ±r)")

# === MATRIX_VIEW_END ===

            st.markdown("---")
            st.caption("Not: AÅŸaÄŸÄ±daki eski uzun listeyi artÄ±k gÃ¶stermiyoruz; Ã§izelge yukarÄ±da.")
                
        # (KALDIRILDI) Eski mesai Ã¶zeti bloÄŸu silindi.
